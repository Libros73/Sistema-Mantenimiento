<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GNB - Gesti√≥n de Activos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <div class="main-container">
        <header class="dashboard-header">
            <div class="logo-area">
                <h1>üè¢ GNB Sudameris</h1>
                <p>Sistema de Gesti√≥n de Mantenimiento | Bosch/Fike</p>
            </div>
            <div class="user-info">
                <span>Ingeniero de Servicio</span>
            </div>
        </header>

        <div class="actions-bar">
            <h2>Inventario de Dispositivos</h2>
            <button class="btn-primary" onclick="abrirModal()">+ Agregar Equipo</button>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre del Equipo</th>
                        <th>Tipo</th>
                        <th>Serial</th>
                        <th>Ubicaci√≥n</th>
                        <th>Estado</th>
                        <th>Observaciones</th> <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for equipo in equipos %}
                    <tr>
                        <td>#{{ equipo.id }}</td>
                        <td><strong>{{ equipo.nombre }}</strong></td>
                        <td>{{ equipo.tipo }}</td>
                        <td><code>{{ equipo.serial }}</code></td>
                        <td>{{ equipo.ubicacion }}</td>
                        <td>
                            <span class="status-badge {{ 'status-ok' if equipo.estado == 'Operativo' else 'status-fail' }}">
                                {{ equipo.estado }}
                            </span>
                        </td>
                        <td>
    <small style="color: #555; font-style: italic;">
        {{ equipo.observaciones if equipo.observaciones else '---' }}
    </small>
</td>
                        <td>
                            <button class="btn-small"
                            onclick="editarEquipo({{ equipo.id }}, '{{ equipo.nombre }}', '{{ equipo.tipo }}', '{{ equipo.serial }}', '{{ equipo.ubicacion }}', '{{ equipo.observaciones }}')">
                            ‚úèÔ∏è</button>
                            <button class="btn-small btn-danger" onclick="eliminarEquipo({{ equipo.id }})">üóëÔ∏è</button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" style="text-align: center;">No hay equipos registrados.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

<div id="modalAgregar" class="modal-overlay">
        <div class="modal-box">
            <h3>üîå Nuevo Dispositivo</h3>
            
            <div class="form-group">
                <label>Nombre del Equipo:</label>
                <input type="text" id="inpNombre" placeholder="Ej: Sensor Humo Sala Juntas">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Tipo:</label>
                    <select id="inpTipo">
                        <option value="Sensor Humo">Sensor Humo</option>
                        <option value="Panel Control">Panel Control</option>
                        <option value="Estaci√≥n Manual">Estaci√≥n Manual</option>
                        <option value="Sirena/Estrobo">Sirena/Estrobo</option>
                        <option value="M√≥dulo Control">M√≥dulo Control</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Serial (√önico):</label>
                    <input type="text" id="inpSerial" placeholder="Ej: SN-2024-X">
                </div>
            </div>

            <div class="form-group">
                <label>Ubicaci√≥n:</label>
                <input type="text" id="inpUbicacion" placeholder="Ej: Torre B - Piso 5">
            </div>

            <div class="form-group">
                <label>Observaciones:</label>
                <textarea id="inpObservaciones" rows="3" placeholder="Estado inicial, notas de instalaci√≥n..."></textarea>
            </div>

            <div class="modal-actions">
                <button onclick="cerrarModal()" class="btn-secondary">Cancelar</button>
                <button onclick="guardarEquipo()" class="btn-primary">Guardar Equipo</button>
            </div>
        </div>
    </div>

    <script>
        const modal = document.getElementById('modalAgregar');
        // CONCEPTO CLAVE: Variable de Estado
        // Si es null = Modo Crear. Si tiene n√∫mero = Modo Editar.
        let idEnEdicion = null; 

        // Abrir Modal Limpio (Para crear)
        function abrirModal() { 
            limpiarFormulario(); // Siempre limpiar antes de abrir
            modal.style.display = 'flex'; 
        }

        // Cerrar Modal
        function cerrarModal() { 
            modal.style.display = 'none'; 
            limpiarFormulario();
        }

        // --- L√ìGICA DE EDICI√ìN ---
        // Esta funci√≥n se llama al dar click en el L√°piz ‚úèÔ∏è
        // Recibe los datos actuales de la fila para rellenar el formulario
        function editarEquipo(id, nombre, tipo, serial, ubicacion, observaciones) {
            idEnEdicion = id; // Cambiamos el estado: ¬°Estamos Editando!
            
            // Llenamos los campos (Data Binding manual)
            document.getElementById('inpNombre').value = nombre;
            document.getElementById('inpTipo').value = tipo;
            document.getElementById('inpSerial').value = serial;
            document.getElementById('inpUbicacion').value = ubicacion;
            document.getElementById('inpObservaciones').value = observaciones;

            // Cambiamos el texto del bot√≥n para dar feedback visual
            document.querySelector('.btn-primary').innerText = "Actualizar Equipo";
            
            modal.style.display = 'flex';
        }

        function limpiarFormulario() {
            idEnEdicion = null; // Reset del estado
            document.getElementById('inpNombre').value = "";
            document.getElementById('inpTipo').value = "Sensor Humo"; // Default
            document.getElementById('inpSerial').value = "";
            document.getElementById('inpUbicacion').value = "";
            document.getElementById('inpObservaciones').value = "";
            document.querySelector('.btn-primary').innerText = "Guardar Equipo";
        
        }
        // --- L√ìGICA DE BORRADO ---
        function eliminarEquipo(id) {
            // 1. Confirmaci√≥n de Seguridad (Vital en ingenier√≠a)
            if(!confirm("¬øEst√°s seguro de que quieres eliminar este equipo del inventario?")) {
                return; // Si dice que no, no hacemos nada
            }

            // 2. Petici√≥n al Backend
            fetch('/api/equipos/' + id, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                alert(data.mensaje);
                location.reload(); // Recargar para ver que desapareci√≥
            })
            .catch(error => console.error('Error:', error));
        }

        // --- CEREBRO PRINCIPAL ---
        function guardarEquipo() {
            const datos = {
                nombre: document.getElementById('inpNombre').value,
                tipo: document.getElementById('inpTipo').value,
                serial: document.getElementById('inpSerial').value,
                ubicacion: document.getElementById('inpUbicacion').value,
                observaciones: document.getElementById('inpObservaciones').value
            };

            if(!datos.nombre || !datos.serial) {
                alert("‚ö†Ô∏è Completa Nombre y Serial.");
                return;
            }

            // DECISI√ìN DE INGENIER√çA:
            // ¬øHacemos POST (Crear) o PUT (Actualizar)?
            let url = '/api/equipos';
            let metodo = 'POST';

            if (idEnEdicion !== null) {
                // Si hay ID, cambiamos la estrategia
                url = '/api/equipos/' + idEnEdicion;
                metodo = 'PUT';
            }

            fetch(url, {
                method: metodo,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(datos)
            })
            .then(response => response.json())
            .then(data => {
                alert(data.mensaje);
                location.reload(); 
            })
            .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>